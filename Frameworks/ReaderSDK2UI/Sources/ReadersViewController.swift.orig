//
//  ReadersViewController.swift
//  ReaderSDK2UI
//
//  Created by Mike Silvis on 9/23/19.
//

import ReaderSDK2
import UIKit

public final class ReadersViewController: UITableViewController {
    private var displayedReaders: [Reader] = [] {
        didSet {
            dataSource.sections = makeSections()
        }
    }

    private let theme: Theme

    private lazy var dataSource = TableViewDataSource(theme: theme, tableView: tableView, sections: makeSections())

    public init(theme: Theme) {
        self.theme = theme

        super.init(style: .grouped)

        title = ReaderSDK2UIStrings.Readers.title
    }

    required init?(coder aDecoder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }

    public override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = theme.secondaryBackgroundColor

        tableView.dataSource = dataSource
        tableView.delegate = dataSource
        tableView.rowHeight = UITableView.automaticDimension
        tableView.estimatedRowHeight = 100

        displayedReaders = ReaderSDK.shared.readerManager.readers
        ReaderSDK.shared.readerManager.add(self)
    }

    public override func viewDidLayoutSubviews() {
        super.viewDidLayoutSubviews()
        view.layoutMargins = ReaderSDK2UILayout.preferredMargins(view: view)
        tableView.separatorInset = view.layoutMargins
    }

    public override var preferredStatusBarStyle: UIStatusBarStyle {
        return theme.statusBarStyle
    }
}

// MARK: - Reader Observer
extension ReadersViewController: ReaderObserver {

    public func readerWasAdded(_ reader: Reader) {
        tableView.performBatchUpdates({
            displayedReaders.append(reader)
            tableView.insertRows(at: [IndexPath(row: displayedReaders.count - 1, section: 0)], with: .left)
        })
    }

    public func readerWasRemoved(_ reader: Reader) {
        guard let index = displayedReaders.firstIndex(of: reader) else {
            return
        }
        tableView.performBatchUpdates({
            displayedReaders.remove(at: index)
            tableView.deleteRows(at: [IndexPath(row: index, section: 0)], with: .left)
        })
    }

    public func readerDidChange(_ reader: Reader, change: ReaderChange) {
        dataSource.sections = makeSections()
        tableView.reloadData()
    }
}

// MARK: - Helpers
extension ReadersViewController {
    private func makeSections() -> [Section] {
        let readerRows = displayedReaders.map(makeRow)

        let connectReaderRow = Row.button(
            theme: theme,
            title: ReaderSDK2UIStrings.Readers.connectReaderButtonTitle,
            tapHandler: { [weak self] in self?.connectReaderButtonPressed() }
        )

        return [
            Section(title: ReaderSDK2UIStrings.Readers.hardwareSectionTitle, rows: readerRows + [connectReaderRow])
        ]
    }

    private func makeRow(for reader: Reader) -> Row {
        return .reader(
            theme: theme,
<<<<<<< Updated upstream
            name: reader.name,
            stateDescription: reader.state.description,
            batteryStatus: reader.batteryStatus,
            tapHandler: { [weak self] in self?.readerPressed(reader) }
||||||| constructed merge base
            name: readerInfo.name,
            stateDescription: readerInfo.state.description,
            batteryStatus: readerInfo.batteryStatus,
            tapHandler: { [weak self] in self?.readerPressed(readerInfo) }
=======
            name: readerInfo.name,
            stateDescription: readerInfo.state.description,
            batteryStatus: readerInfo.batteryStatus,
            firmwareUpdatePercentage:  (readerInfo.state == .updatingFirmware ? readerInfo.firmwareUpdatePercentage : nil),
            tapHandler: { [weak self] in self?.readerPressed(readerInfo) }
>>>>>>> Stashed changes
        )
    }

    func readerPressed(_ reader: Reader) {
        let readerDetail = ReaderDetailViewController(reader: reader, theme: theme, delegate: self)
        navigationController?.pushViewController(readerDetail, animated: true)
    }

    func connectReaderButtonPressed() {
        let pairingViewController = ReaderPairingViewController(theme: theme, delegate: self)
        let navigationController = UINavigationController(rootViewController: pairingViewController)
        navigationController.modalPresentationStyle = .formSheet
        present(navigationController, animated: true, completion: nil)
    }
    
    private func showError(title: String, message: String) {
        let alert = UIAlertController(
            title: title,
            message: message,
            preferredStyle: .alert
        )
        let dismissAction = UIAlertAction(title: ReaderSDK2UIStrings.errorDismissButtonTitle, style: .default, handler: nil)
        alert.addAction(dismissAction)
        present(alert, animated: true, completion: nil)
    }
}

// MARK: - ReaderDetailViewControllerDelegate

extension ReadersViewController: ReaderDetailViewControllerDelegate {
    public func readerDetailViewController(_ readerDetailViewController: ReaderDetailViewController, didBecomeInvalidDueToReaderRemoval removedReader: Reader) {
        navigationController?.popViewController(animated: true)
    }
}

// MARK: - ReaderPairingViewControllerDelegate

extension ReadersViewController: ReaderPairingViewControllerDelegate {
    public func readerPairingViewControllerDidFinish(_ readerPairingViewController: ReaderPairingViewController) {
        dismiss(animated: true, completion: nil)
    }
    
    public func readerPairingViewController(_ readerPairingViewController: ReaderPairingViewController, didFailWith error: Error) {
        dismiss(animated: true) {
            self.showError(title: ReaderSDK2UIStrings.ReaderPairing.errorTitle, message: error.localizedDescription)
        }
    }
}

